<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Mini App</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>

    <!-- Профиль пользователя -->
    <div class="profile">
        <img id="avatar" class="avatar" src="" alt="Avatar">
        <p id="username">User name</p>
        <p id="points">Points: 0</p>
    </div>

    <!-- Контейнер для кликабельных зон -->
    <div id="background-container" class="background-container">
        <!-- Кликавельные зоны для основных вкладок -->
        <div class="clickable-area stats" data-link="/stats"></div>
        <div class="clickable-area earn" data-link="/earn"></div>
        <div class="clickable-area home" data-link="/home"></div>
        <div class="clickable-area play" data-link="/play"></div>
        <div class="clickable-area friends" data-link="/friends"></div>

        <!-- Кликавельные зоны для вкладки Earn -->
        <div class="earn-area earn1" data-link="https://t.me/lordkubera" style="display: none;"></div>
        <div class="earn-area earn2" data-link="https://example.com" style="display: none;"></div>
        <div class="earn-area earn3" data-link="https://example.com" style="display: none;"></div>
        <div class="earn-area earn4" data-link="https://example.com" style="display: none;"></div>
        <div class="earn-area earn5" data-link="https://example.com" style="display: none;"></div>
        <div class="earn-area earn6" style="display: none;"></div>
        <div class="earn-area earn7" style="display: none;"></div>
        <div class="earn-area earn8" style="display: none;"></div>
        <div class="earn-area earn9" style="display: none;"></div>
        <div class="earn-area earn10" style="display: none;"></div>
    </div>

    <!-- Скрипт для работы с Telegram Web App -->
    <script>
        // Функция для обновления профиля пользователя
        function updateUserProfile(avatarUrl, username, points) {
            document.getElementById('avatar').src = avatarUrl;
            document.getElementById('username').textContent = username;
            document.getElementById('points').textContent = `Points: ${points}`;
        }

        // Получение данных пользователя из Telegram Web App
        const telegram = window.Telegram.WebApp;

        if (telegram.initDataUnsafe.user) {
            const userId = telegram.initDataUnsafe.user.id;
            const username = telegram.initDataUnsafe.user.username || "No username";

            // Регистрация пользователя на сервере
            fetch('/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: userId, username: username })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    const avatarUrl = data.avatar_url || '/static/default_avatar.png'; // Путь к аватару
                    const points = data.points || 0;
                    updateUserProfile(avatarUrl, username, points);
                }
            })
            .catch(error => console.error('Error:', error));
        }
    </script>

    <!-- Скрипт для работы с кликабельными зонами -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            function changeBackground(area) {
                const backgroundContainer = document.getElementById('background-container');
                if (area === 'earn') {
                    backgroundContainer.style.backgroundImage = "url('/static/earn.jpg')";
                    document.querySelectorAll('.earn-area').forEach(area => {
                        area.style.display = 'block';
                    });
                } else {
                    backgroundContainer.style.backgroundImage = "url('/static/fon.jpg')";
                    document.querySelectorAll('.earn-area').forEach(area => {
                        area.style.display = 'none';
                    });
                }
            }

            document.querySelectorAll('.clickable-area').forEach(area => {
                area.addEventListener('click', (event) => {
                    event.preventDefault();
                    if (area.classList.contains('earn')) {
                        changeBackground('earn');
                    } else if (area.classList.contains('stats')) {
                        changeBackground('stats');
                    } else if (area.classList.contains('home')) {
                        changeBackground('home');
                    } else if (area.classList.contains('play')) {
                        changeBackground('play');
                    } else if (area.classList.contains('friends')) {
                        changeBackground('friends');
                    }
                });
            });

            document.querySelectorAll('.earn-area').forEach(area => {
                area.addEventListener('click', (event) => {
                    event.preventDefault();
                    const link = area.getAttribute('data-link');
                    if (link) {
                        window.open(link, '_blank');
                    }
                });
            });

            // Инициализация Telegram Web Apps SDK
            const tg = window.Telegram.WebApp;
            const user = tg.initDataUnsafe.user;
            const user_id = user.id;
            const username = user.username || 'Unknown';

            // Отправляем данные для регистрации на сервер
            fetch('/register', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    user_id: user_id,
                    username: username
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log('Register response:', data); // Логируем ответ для отладки

                document.getElementById("username").textContent = username;

                // Получение аватара пользователя из базы данных
                fetch(`/profile/${user_id}`)
                    .then(response => response.json())
                    .then(data => {
                        console.log('Avatar response:', data); // Логируем ответ для отладки
                        if (data.avatar_url) {
                            document.getElementById("avatar").src = data.avatar_url;
                        } else {
                            document.getElementById("avatar").src = ''; // Или какой-то плейсхолдер, если нужно
                        }
                    })
                    .catch(error => console.error('Error fetching avatar:', error)); // Логирование ошибок
            })
            .catch(error => console.error('Error registering user:', error)); // Логирование ошибок
        });
    </script>

    <!-- Скрипт для работы с кликабельными зонами -->
    <script src="{{ url_for('static', filename='scripts.js') }}"></script>
</body>
</html>
